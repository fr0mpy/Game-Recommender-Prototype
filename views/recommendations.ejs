<%- include('partials/header', { title: 'Game Recommendations - Slot Forge' })
%>

<div class="max-w-6xl mx-auto">
  <!-- Back Navigation -->
  <div class="mb-6">
    <a
      href="/"
      class="inline-flex items-center text-casino hover:text-casino-dark transition duration-200"
    >
      <svg
        class="w-5 h-5 mr-2"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M10 19l-7-7m0 0l7-7m-7 7h18"
        ></path>
      </svg>
      Back to Game Selection
    </a>
  </div>

  <!-- Selected Game Info -->
  <% if (selectedGame) { %>
  <div class="bg-white rounded-lg shadow-md p-6 mb-6">
    <h2 class="text-xl font-semibold text-casino-dark mb-4">üéØ Selected Game</h2>
    <div
      class="bg-gradient-to-r from-casino to-casino-dark text-white rounded-lg p-4"
    >
      <div class="flex flex-col md:flex-row md:items-center md:justify-between">
        <div>
          <h3 class="text-xl font-bold mb-1"><%= selectedGame.title %></h3>
          <p class="text-casino-100 mb-2">by <%= selectedGame.studio %></p>
          <p class="text-sm">
            <%= selectedGame.description || 'No description available' %>
          </p>
        </div>
        <div class="flex flex-wrap gap-2 mt-3 md:mt-0">
          <% if (selectedGame.theme) { %> <% selectedGame.theme.forEach(theme =>
          { %>
          <span class="bg-white bg-opacity-20 px-2 py-1 rounded text-xs"
            ><%= theme %></span
          >
          <% }) %> <% } %>
          <span class="bg-white bg-opacity-20 px-2 py-1 rounded text-xs"
            ><%= selectedGame.volatility %> volatility</span
          >
          <span class="bg-white bg-opacity-20 px-2 py-1 rounded text-xs"
            ><%= selectedGame.rtp %>% RTP</span
          >
        </div>
      </div>
    </div>
  </div>
  <% } %>

  <!-- Player Context Summary -->
  <% if (playerContext && playerContext.confidence) { %>
  <div class="bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 rounded-lg p-4 mb-6">
    <div class="flex items-center justify-between mb-3">
      <h3 class="text-sm font-semibold text-green-800">üéØ Recommendation Context</h3>
      <div class="w-10 h-10 rounded-full flex items-center justify-center text-white font-bold text-sm
                  <%= playerContext.confidence.level === 'high' ? 'bg-green-500' : 
                      playerContext.confidence.level === 'medium' ? 'bg-yellow-500' : 'bg-gray-500' %>">
        <%= Math.round(playerContext.confidence.score * 100) %>%
      </div>
    </div>
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-xs text-green-700">
      <div>
        <span class="font-medium">Time:</span> 
        <%= playerContext.temporal ? playerContext.temporal.playTimeContext.description : 'Unknown' %>
      </div>
      <div>
        <span class="font-medium">Device:</span> 
        <%= playerContext.deviceType || 'Unknown' %>
      </div>
      <% if (playerContext.temporal && playerContext.temporal.sportsSeason && playerContext.temporal.sportsSeason.length > 0) { %>
      <div>
        <span class="font-medium">Sports Season:</span>
        <%= playerContext.temporal.sportsSeason.map(s => s.sport.toUpperCase()).join(', ') %>
      </div>
      <% } %>
      <% if (playerContext.temporal && playerContext.temporal.currentTime) { %>
      <div>
        <span class="font-medium">Context:</span>
        <%= playerContext.temporal.currentTime.isWeekend ? 'Weekend' : 'Weekday' %>
        <%= playerContext.temporal.currentTime.isEvening ? 'Evening' : '' %>
      </div>
      <% } %>
    </div>
  </div>
  <% } %>

  <!-- Recommendations Results -->
  <div class="bg-white rounded-lg shadow-md p-6">
    <h2 class="text-2xl font-semibold text-casino-dark mb-6">üîç Similar Games</h2>

    <% if (recommendations.length === 0) { %>
    <div class="text-center py-12">
      <div class="text-6xl mb-4">ü§∑</div>
      <h3 class="text-xl font-semibold text-casino-dark text-opacity-70 mb-2">
        No Similar Games Found
      </h3>
      <p class="text-casino-dark text-opacity-60 mb-6">
        Try adjusting the recommendation weights or generate more games for
        better matches.
      </p>
      <a
        href="/"
        class="bg-casino hover:bg-casino-dark text-white font-bold py-2 px-6 rounded transition duration-200"
      >
        Try Different Settings
      </a>
    </div>
    <% } else { %>
    <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
      <% recommendations.forEach((rec, index) => { %>
      <div
        class="border rounded-lg p-4 hover:shadow-lg transition duration-200 <%= rec.confidence >= 80 ? 'border-green-400 bg-green-50' : rec.confidence >= 60 ? 'border-yellow-400 bg-yellow-50' : 'border-gray-300' %>"
      >
        <!-- Confidence Badge -->
        <div class="flex justify-between items-start mb-3">
          <span class="text-sm font-semibold text-casino-dark text-opacity-60"
            >#<%= index + 1 %> Match</span
          >
          <div class="flex items-center">
            <div
              class="w-12 h-12 rounded-full flex items-center justify-center text-white font-bold text-sm <%= rec.confidence >= 80 ? 'bg-green-500' : rec.confidence >= 60 ? 'bg-yellow-500' : 'bg-gray-500' %>"
            >
              <%= rec.confidence %>%
            </div>
          </div>
        </div>

        <!-- Game Info -->
        <div class="mb-4">
          <h3 class="text-lg font-semibold text-casino-dark mb-1 line-clamp-2">
            <%= rec.game.title %>
          </h3>
          <p class="text-sm text-casino-dark text-opacity-70 mb-2">by <%= rec.game.studio %></p>
          <% if (rec.game.description) { %>
          <p class="text-sm text-casino-dark text-opacity-80 line-clamp-3">
            <%= rec.game.description %>
          </p>
          <% } %>
        </div>

        <!-- Game Attributes -->
        <div class="space-y-2 mb-4">
          <!-- Themes -->
          <% if (rec.game.theme && rec.game.theme.length > 0) { %>
          <div class="flex flex-wrap gap-1">
            <% rec.game.theme.forEach(theme => { %>
            <span
              class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs font-medium"
              ><%= theme %></span
            >
            <% }) %>
          </div>
          <% } %>

          <!-- Game Stats -->
          <div class="flex flex-wrap gap-1">
            <span
              class="bg-purple-100 text-purple-800 px-2 py-1 rounded text-xs font-medium"
            >
              <%= rec.game.volatility %> volatility
            </span>
            <span
              class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs font-medium"
            >
              RTP: <%= rec.game.rtp %>%
            </span>
            <% if (rec.game.maxWin) { %>
            <span
              class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded text-xs font-medium"
            >
              Max: <%= rec.game.maxWin %>x
            </span>
            <% } %>
          </div>

          <!-- Game Mechanics -->
          <% if (rec.game.mechanics && rec.game.mechanics.length > 0) { %>
          <div class="flex flex-wrap gap-1">
            <% rec.game.mechanics.slice(0, 3).forEach(mechanic => { %>
            <span class="bg-gray-100 text-casino-dark text-opacity-80 px-2 py-1 rounded text-xs"
              ><%= mechanic %></span
            >
            <% }) %> <% if (rec.game.mechanics.length > 3) { %>
            <span class="bg-gray-100 text-casino-dark text-opacity-80 px-2 py-1 rounded text-xs"
              >+<%= rec.game.mechanics.length - 3 %> more</span
            >
            <% } %>
          </div>
          <% } %>
        </div>

        <!-- Match Explanation -->
        <div class="border-t pt-3">
          <p class="text-xs text-casino-dark text-opacity-70 mb-2">
            <strong>Why this match:</strong>
          </p>
          <div class="text-sm text-casino-dark text-opacity-80">
            <% if (rec.explanation) { %>
              <p><%= rec.explanation %></p>
            <% } else { %>
              <div class="text-xs space-y-1">
                <% if (selectedGame && rec.game.theme && selectedGame.theme) { %> <%
                const sharedThemes = selectedGame.theme.filter(t =>
                rec.game.theme.includes(t)); %> <% if (sharedThemes.length > 0) { %>
                <div>üé® Shared themes: <%= sharedThemes.join(', ') %></div>
                <% } %> <% } %> <% if (selectedGame && selectedGame.volatility ===
                rec.game.volatility) { %>
                <div>‚ö° Same volatility level (<%= rec.game.volatility %>)</div>
                <% } %> <% if (selectedGame && selectedGame.studio ===
                rec.game.studio) { %>
                <div>üè¢ Same studio (<%= rec.game.studio %>)</div>
                <% } %> <% if (selectedGame && rec.game.mechanics &&
                selectedGame.mechanics) { %> <% const sharedMechanics =
                selectedGame.mechanics.filter(m => rec.game.mechanics.includes(m));
                %> <% if (sharedMechanics.length > 0) { %>
                <div>üîß Shared mechanics: <%= sharedMechanics.join(', ') %></div>
                <% } %> <% } %>
              </div>
            <% } %>
          </div>
        </div>
      </div>
      <% }) %>
    </div>

    <!-- Additional Actions -->
    <div class="mt-8 text-center border-t pt-6">
      <div class="flex flex-col sm:flex-row justify-center gap-4">
        <a
          href="/"
          class="bg-casino hover:bg-casino-dark text-white font-bold py-2 px-6 rounded transition duration-200"
        >
          üîÑ Try Different Game
        </a>
        <form method="POST" action="/recommend" class="inline">
          <input
            type="hidden"
            name="gameId"
            value="<%= selectedGame ? selectedGame.id : '' %>"
          />
          <input type="hidden" name="theme" value="0.3" />
          <input type="hidden" name="volatility" value="0.4" />
          <input type="hidden" name="studio" value="0.2" />
          <input type="hidden" name="mechanics" value="0.1" />
          <button
            type="submit"
            class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded transition duration-200"
          >
            üé≤ Different Weight Mix
          </button>
        </form>
      </div>
    </div>
    <% } %>
  </div>
</div>

<%- include('partials/footer') %>
