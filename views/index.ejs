<%- include('partials/header', { title: 'Slot Forge - Home' }) %>

<div class="max-w-6xl mx-auto">
  <!-- Player Context Confidence Panel -->
  <% if (playerContext && playerContext.confidence) { %>
  <div
    class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-lg p-4 mb-6"
  >
    <div class="flex items-center justify-between">
      <div>
        <h3 class="text-sm font-semibold text-blue-800 mb-1">
          üéØ Player Context Analysis
        </h3>
        <p class="text-xs text-blue-700">
          <span class="font-medium"
            >Confidence: <%= playerContext.confidence.score ?
            Math.round(playerContext.confidence.score * 100) : 0 %>%</span
          >
          <span class="mx-2">‚Ä¢</span>
          <span class="capitalize"><%= playerContext.confidence.level %></span>
          data quality
        </p>
      </div>
      <div class="text-right">
        <div
          class="w-12 h-12 rounded-full flex items-center justify-center text-white font-bold text-sm <%= playerContext.confidence.level === 'high' ? 'bg-green-500' : playerContext.confidence.level === 'medium' ? 'bg-yellow-500' : 'bg-gray-500' %>"
        >
          <%= Math.round(playerContext.confidence.score * 100) %>%
        </div>
      </div>
    </div>

    <!-- Context Information Row -->
    <div class="mt-3 grid grid-cols-1 md:grid-cols-3 gap-4 text-xs">
      <!-- Device & System Info -->
      <div class="bg-white rounded-lg p-3 border border-blue-100">
        <h4 class="font-medium text-blue-800 mb-2">üì± Device & System</h4>
        <div class="space-y-1">
          <div class="flex justify-between">
            <span class="text-casino-dark text-opacity-70">Device:</span>
            <span class="font-medium capitalize"
              ><%= playerContext.deviceType || 'Unknown' %></span
            >
          </div>
          <div class="flex justify-between">
            <span class="text-casino-dark text-opacity-70">System Theme:</span>
            <span
              class="font-medium capitalize <%= playerContext.systemTheme === 'dark' ? 'text-casino-dark' : playerContext.systemTheme === 'light' ? 'text-yellow-600' : 'text-gray-500' %>"
            >
              <%= playerContext.systemTheme === 'dark' ? 'üåô Dark Mode' : playerContext.systemTheme === 'light' ? '‚òÄÔ∏è Light Mode' : '‚ùì Unknown' %>
            </span>
          </div>
        </div>
      </div>

      <!-- Referrer & Source -->
      <div class="bg-white rounded-lg p-3 border border-blue-100">
        <h4 class="font-medium text-blue-800 mb-2">üîó Traffic Source</h4>
        <div class="space-y-1">
          <% if (playerContext.referrer &&
          playerContext.referrer.includes('ballysports')) { %>
          <div
            class="bg-green-50 border border-green-200 rounded px-2 py-1 mb-1"
          >
            <span class="text-green-700 font-medium"
              >üèà Bally Sports Referrer</span
            >
          </div>
          <% } else if (playerContext.referrer &&
          (playerContext.referrer.includes('google') ||
          playerContext.referrer.includes('search'))) { %>
          <div class="bg-blue-50 border border-blue-200 rounded px-2 py-1 mb-1">
            <span class="text-blue-700 font-medium">üîç Search Engine</span>
          </div>
          <% } else if (playerContext.referrer) { %>
          <div class="bg-gray-50 border border-gray-200 rounded px-2 py-1 mb-1">
            <span class="text-casino-dark text-opacity-80 font-medium">üåê External Site</span>
          </div>
          <% } else { %>
          <div
            class="bg-purple-50 border border-purple-200 rounded px-2 py-1 mb-1"
          >
            <span class="text-purple-700 font-medium">üì± Direct Visit</span>
          </div>
          <% } %>
        </div>
      </div>

      <!-- Time & Location -->
      <div class="bg-white rounded-lg p-3 border border-blue-100">
        <h4 class="font-medium text-blue-800 mb-2">üåç Time & Location</h4>
        <div class="space-y-1">
          <% if (playerContext.temporal && playerContext.temporal.currentTime &&
          playerContext.temporal.currentTime.localeInfo) { %>
          <div class="flex justify-between">
            <span class="text-casino-dark text-opacity-70">Local Time:</span>
            <span class="font-medium"
              ><%= playerContext.temporal.currentTime.localeInfo.timeString
              %></span
            >
          </div>
          <div class="flex justify-between">
            <span class="text-casino-dark text-opacity-70">Day:</span>
            <span class="font-medium"
              ><%= playerContext.temporal.currentTime.localeInfo.dayName
              %></span
            >
          </div>
          <% } %>
          <div class="flex justify-between">
            <span class="text-casino-dark text-opacity-70">Timezone:</span>
            <span class="font-medium"
              ><%= playerContext.timezone || 'Unknown' %></span
            >
          </div>
        </div>
      </div>
    </div>

    <% if (playerContext.confidence.factors &&
    playerContext.confidence.factors.length > 0) { %>
    <div class="mt-3 flex flex-wrap gap-2">
      <% playerContext.confidence.factors.forEach(factor => { %>
      <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs"
        >‚úì <%= factor %></span
      >
      <% }) %>
    </div>
    <% } %> <% if (playerContext.temporal &&
    playerContext.temporal.activeHolidays &&
    playerContext.temporal.activeHolidays.length > 0) { %>
    <div class="mt-3 border-t border-blue-200 pt-3">
      <p class="text-xs text-blue-700 font-medium mb-2">üéâ Active Events:</p>
      <div class="flex flex-wrap gap-2">
        <% playerContext.temporal.activeHolidays.forEach(holiday => { %>
        <span class="bg-purple-100 text-purple-800 px-2 py-1 rounded text-xs">
          üéä <%= holiday.name.replace('-', ' ') %>
        </span>
        <% }) %>
      </div>
    </div>
    <% } %>

    <!-- LLM Context Summary -->
    <% if (playerContext.contextSummary) { %>
    <div class="mt-3 border-t border-blue-200 pt-3">
      <p class="text-xs text-blue-700 font-medium mb-2">
        ü§ñ AI Context Analysis:
      </p>
      <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
        <p class="text-xs text-blue-800 leading-relaxed italic">
          "<%= playerContext.contextSummary %>"
        </p>
      </div>
    </div>
    <% } %> <% if (crossSell && crossSell.eligible) { %>
    <div class="mt-3 border-t border-blue-200 pt-3">
      <p class="text-xs text-green-700 font-medium mb-2">
        üèà Sports Cross-sell Opportunity:
      </p>
      <div class="flex flex-wrap gap-2">
        <% crossSell.factors.forEach(factor => { %>
        <span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs"
          >‚ö° <%= factor %></span
        >
        <% }) %>
      </div>
    </div>
    <% } %>
  </div>
  <% } %>
  <!-- Success/Error Messages -->
  <% if (message) { %>
  <div
    class="mb-6 p-4 rounded-lg <%= message.type === 'success' ? 'bg-green-100 border-green-400 text-green-700' : 'bg-red-100 border-red-400 text-red-700' %> border"
  >
    <%= message.text %>
  </div>
  <% } %>

  <!-- Generate Games Section -->
  <div class="bg-white rounded-lg shadow-md p-6 mb-6">
    <h2 class="text-xl font-semibold text-casino-dark mb-4">
      üìä Game Dataset Generation
    </h2>

    <form method="POST" action="/generate" class="space-y-4" id="generateForm">
      <div class="flex items-start justify-between gap-6">
        <div class="flex-1">
          <p class="text-casino-dark text-opacity-70 mb-2">
            Current dataset:
            <span class="font-bold text-casino"><%= games.length %></span> games
          </p>

          <label
            for="customPrompt"
            class="block text-sm font-medium text-casino-dark text-opacity-80 mb-2"
          >
            Custom Generation Prompt:
          </label>
          <textarea
            id="customPrompt"
            name="customPrompt"
            rows="3"
            class="w-full p-3 border border-gray-300 rounded-md focus:ring-casino focus:border-casino"
            placeholder="Enter your custom prompt for generating slot games..."
          ><%= customPrompt || 'Generate 100 slot games' %></textarea>
          <p class="text-xs text-casino-dark text-opacity-60 mt-1">
            Customize how the AI generates your games.
          </p>
        </div>

        <div class="flex flex-col gap-3">
          <button
            type="button"
            id="generateButton"
            class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition duration-200 whitespace-nowrap disabled:opacity-50 disabled:cursor-not-allowed"
          >
            <span id="generateButtonText">ü§ñ Generate Games</span>
            <span id="generateButtonSpinner" class="hidden">
              <svg
                class="animate-spin -ml-1 mr-3 h-4 w-4 text-white inline"
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24"
              >
                <circle
                  class="opacity-25"
                  cx="12"
                  cy="12"
                  r="10"
                  stroke="currentColor"
                  stroke-width="4"
                ></circle>
                <path
                  class="opacity-75"
                  fill="currentColor"
                  d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                ></path>
              </svg>
              Generating...
            </span>
          </button>
        </div>
      </div>
    </form>

    <!-- Generation Progress Area (hidden by default) -->
    <div
      id="generationProgress"
      class="hidden mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg"
    >
      <div class="flex items-center mb-2">
        <svg
          class="animate-spin -ml-1 mr-3 h-5 w-5 text-blue-500"
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
        >
          <circle
            class="opacity-25"
            cx="12"
            cy="12"
            r="10"
            stroke="currentColor"
            stroke-width="4"
          ></circle>
          <path
            class="opacity-75"
            fill="currentColor"
            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
          ></path>
        </svg>
        <h3 class="text-lg font-semibold text-blue-800">Generating Games</h3>
      </div>
      <div class="text-sm text-blue-700 mb-3">
        <p id="progressMessage">Preparing AI generation...</p>
        <p class="text-xs mt-1">
          Large datasets are generated in chunks to ensure quality. This may
          take 1-2 minutes.
        </p>
      </div>
      <div class="w-full bg-blue-200 rounded-full h-2">
        <div
          id="progressBar"
          class="bg-blue-600 h-2 rounded-full transition-all duration-500"
          style="width: 0%"
        ></div>
      </div>
    </div>
  </div>

  <% if (games.length > 0) { %>
  <!-- Game Selection & Recommendation Section -->
  <div class="bg-white rounded-lg shadow-md p-6 mb-6">
    <h2 class="text-xl font-semibold text-casino-dark mb-4">
      üéØ Get Recommendations
    </h2>
    <form method="POST" action="/recommend" class="space-y-6" onsubmit="return handleRecommendSubmit(event)">
      <!-- Hidden session ID field to ensure consistency -->
      <input type="hidden" name="sessionId" id="sessionIdField" value="<%= sessionId %>" />
      <!-- Game Selection -->
      <div>
        <label
          for="gameId"
          class="block text-sm font-medium text-casino-dark text-opacity-80 mb-2"
        >
          Select a game to find similar games:
        </label>
        <select
          name="gameId"
          id="gameId"
          required
          class="w-full p-3 border border-gray-300 rounded-md focus:ring-casino focus:border-casino"
        >
          <option value="">Choose a game...</option>
          <% games.forEach(game => { %>
          <option value="<%= game.id %>">
            <%- game.title %> - <%- game.studio %> (<%- game.volatility %>
            volatility, <%- game.rtp %>% RTP)
          </option>
          <% }) %>
        </select>
      </div>

      <!-- Weight Configuration -->
      <div>
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-md font-medium text-casino-dark text-opacity-80">
            üéöÔ∏è Recommendation Weights
          </h3>
          <div class="bg-green-100 border border-green-300 rounded-lg px-3 py-1">
            <span class="text-sm font-semibold text-green-800">Total: </span>
            <span id="total-percentage" class="text-sm font-bold text-green-800">100%</span>
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
          <div>
            <label
              for="theme"
              class="block text-sm font-medium text-casino-dark text-opacity-70 mb-1"
            >
              Theme Similarity
            </label>
            <input
              type="range"
              id="theme"
              name="theme"
              min="0"
              max="1"
              step="0.01"
              value="<%= settings.theme %>"
              class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider"
              oninput="updateSliderValue('theme', this.value)"
            />
            <div class="flex justify-between text-xs text-casino-dark text-opacity-60 mt-1">
              <span>0%</span>
              <span id="theme-value" class="font-semibold text-casino"
                ><%= Math.round(settings.theme * 100) %>%</span
              >
              <span>100%</span>
            </div>
          </div>

          <div>
            <label
              for="volatility"
              class="block text-sm font-medium text-casino-dark text-opacity-70 mb-1"
            >
              Volatility Matching
            </label>
            <input
              type="range"
              id="volatility"
              name="volatility"
              min="0"
              max="1"
              step="0.01"
              value="<%= settings.volatility %>"
              class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider"
              oninput="updateSliderValue('volatility', this.value)"
            />
            <div class="flex justify-between text-xs text-casino-dark text-opacity-60 mt-1">
              <span>0%</span>
              <span id="volatility-value" class="font-semibold text-casino"
                ><%= Math.round(settings.volatility * 100) %>%</span
              >
              <span>100%</span>
            </div>
          </div>

          <div>
            <label
              for="studio"
              class="block text-sm font-medium text-casino-dark text-opacity-70 mb-1"
            >
              Studio Preference
            </label>
            <input
              type="range"
              id="studio"
              name="studio"
              min="0"
              max="1"
              step="0.01"
              value="<%= settings.studio %>"
              class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider"
              oninput="updateSliderValue('studio', this.value)"
            />
            <div class="flex justify-between text-xs text-casino-dark text-opacity-60 mt-1">
              <span>0%</span>
              <span id="studio-value" class="font-semibold text-casino"
                ><%= Math.round(settings.studio * 100) %>%</span
              >
              <span>100%</span>
            </div>
          </div>

          <div>
            <label
              for="mechanics"
              class="block text-sm font-medium text-casino-dark text-opacity-70 mb-1"
            >
              Game Mechanics
            </label>
            <input
              type="range"
              id="mechanics"
              name="mechanics"
              min="0"
              max="1"
              step="0.01"
              value="<%= settings.mechanics %>"
              class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider"
              oninput="updateSliderValue('mechanics', this.value)"
            />
            <div class="flex justify-between text-xs text-casino-dark text-opacity-60 mt-1">
              <span>0%</span>
              <span id="mechanics-value" class="font-semibold text-casino"
                ><%= Math.round(settings.mechanics * 100) %>%</span
              >
              <span>100%</span>
            </div>
          </div>
        </div>
      </div>

      <div class="flex justify-center">
        <button
          type="submit"
          class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg transition duration-200 text-lg"
        >
          üîç Find Similar Games
        </button>
      </div>
    </form>
  </div>

  <!-- Export Section -->
  <div class="bg-white rounded-lg shadow-md p-6">
    <h2 class="text-xl font-semibold text-casino-dark mb-4">
      üìÅ Export Game Data
    </h2>
    <div class="flex items-center justify-between">
      <p class="text-casino-dark text-opacity-70">
        Download the current dataset for analysis or external use
      </p>
      <div class="flex gap-3">
        <a
          href="/export/json"
          class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition duration-200"
        >
          üìÑ Download JSON
        </a>
        <a
          href="/export/csv"
          class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded transition duration-200"
        >
          üìä Download CSV
        </a>
      </div>
    </div>
  </div>
  <% } else { %>
  <!-- Empty State -->
  <div class="bg-white rounded-lg shadow-md p-12 text-center">
    <div class="text-6xl mb-4">üé∞</div>
    <h2 class="text-2xl font-semibold text-casino-dark mb-2">No Games Yet</h2>
    <p class="text-casino-dark text-opacity-70 mb-6">
      Generate your first dataset of 100 fictional slot games to get started
      with recommendations.
    </p>
  </div>
  <% } %>
</div>

<script>
  // Session and context tracking
  const sessionId = "<%= sessionId %>";
  
  // Custom games storage in localStorage
  function saveCustomGames(games) {
    localStorage.setItem('slotForge_customGames', JSON.stringify(games));
    localStorage.setItem('slotForge_hasCustomGames', 'true');
    
    // Sync to server session immediately
    syncCustomGamesToServer(games);
  }
  
  function loadCustomGames() {
    const hasCustom = localStorage.getItem('slotForge_hasCustomGames');
    if (hasCustom === 'true') {
      const customGames = localStorage.getItem('slotForge_customGames');
      return customGames ? JSON.parse(customGames) : null;
    }
    return null;
  }
  
  function clearCustomGames() {
    localStorage.removeItem('slotForge_customGames');
    localStorage.removeItem('slotForge_hasCustomGames');
  }
  
  // Sync custom games from localStorage to server session
  async function syncCustomGamesToServer(games = null) {
    if (!games) {
      games = loadCustomGames();
    }
    
    if (!games || games.length === 0) {
      console.log('No custom games to sync');
      return;
    }
    
    console.log(`Syncing ${games.length} custom games to server...`);
    
    try {
      const response = await fetch('/api/sync-custom-games', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-Session-ID': sessionId
        },
        body: JSON.stringify({ games: games })
      });
      
      if (!response.ok) {
        console.error('Failed to sync custom games to server:', response.statusText);
        return false;
      }
      
      const result = await response.json();
      console.log('Sync result:', result);
      return true;
    } catch (error) {
      console.error('Error syncing custom games:', error);
      return false;
    }
  }

  // Detect and send timezone and system theme
  function detectAndSendClientContext() {
    const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
    const systemTheme = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    
    // Send context via fetch to update server-side context
    fetch('/api/update-context', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Session-ID': sessionId,
        'X-Timezone': timezone,
        'X-System-Theme': systemTheme
      },
      body: JSON.stringify({
        timezone: timezone,
        systemTheme: systemTheme,
        userAgent: navigator.userAgent,
        language: navigator.language
      })
    }).catch(error => console.log('Context update failed:', error));
  }

  // Store session ID for future requests
  if (sessionId) {
    localStorage.setItem("slotForge_sessionId", sessionId);

    // Store player preferences for context tracking
    const playerPrefs = {
      visitCount:
        (parseInt(localStorage.getItem("slotForge_visitCount")) || 0) + 1,
      lastVisit: new Date().toISOString(),
      preferredThemes: [], // Could be populated from user selections
      ballysContext: checkBallysSportsContext(),
    };
    localStorage.setItem("slotForge_playerPrefs", JSON.stringify(playerPrefs));
    localStorage.setItem("slotForge_visitCount", playerPrefs.visitCount);
  }

  function checkBallysSportsContext() {
    // Check for Bally's Sports indicators
    const referrer = document.referrer;
    const hasBallysCookies =
      document.cookie.includes("ballysports") ||
      document.cookie.includes("bally");

    return {
      referredFromBallys:
        referrer.includes("ballysports") || referrer.includes("bally"),
      hasBallyCookies: hasBallysCookies,
      detectedAt: new Date().toISOString(),
    };
  }

  function updateSliderValue(sliderId, newValue, skipRebalance = false) {
    const newValueFloat = parseFloat(newValue);
    
    if (!skipRebalance) {
      // Rebalance other sliders to maintain 100% total
      rebalanceSliders(sliderId, newValueFloat);
    } else {
      // Update display with smart rounding to ensure 100% total
      updateAllSliderDisplays();
      saveAllWeights();
    }
  }
  
  function rebalanceSliders(changedSliderId, newValue) {
    const sliderIds = ['theme', 'volatility', 'studio', 'mechanics'];
    const otherSliders = sliderIds.filter(id => id !== changedSliderId);
    
    // Calculate remaining weight to distribute
    const remainingWeight = 1.0 - newValue;
    
    // Get current values of other sliders
    const currentValues = {};
    let currentTotal = 0;
    
    otherSliders.forEach(id => {
      const slider = document.getElementById(id);
      if (slider) {
        currentValues[id] = parseFloat(slider.value) || 0;
        currentTotal += currentValues[id];
      }
    });
    
    // Calculate new values for other sliders
    const newValues = {};
    otherSliders.forEach(id => {
      if (currentTotal > 0) {
        // Proportional adjustment
        newValues[id] = (currentValues[id] / currentTotal) * remainingWeight;
      } else {
        // Equal distribution if all others were zero
        newValues[id] = remainingWeight / otherSliders.length;
      }
    });
    
    // Normalize to ensure exact 100% total (fix rounding errors)
    const calculatedTotal = newValue + Object.values(newValues).reduce((sum, val) => sum + val, 0);
    const normalizationFactor = 1.0 / calculatedTotal;
    
    // Apply normalization to the changed slider too
    const normalizedNewValue = newValue * normalizationFactor;
    document.getElementById(changedSliderId).value = normalizedNewValue;
    
    // Apply normalized values to other sliders
    otherSliders.forEach(id => {
      const slider = document.getElementById(id);
      if (slider) {
        const normalizedValue = newValues[id] * normalizationFactor;
        // Clamp to valid range
        const clampedValue = Math.max(0, Math.min(1, normalizedValue));
        
        // Update slider and display
        slider.value = clampedValue;
        updateSliderValue(id, clampedValue, true); // Skip rebalance to avoid recursion
      }
    });
    
    // Update the changed slider's display too (since we normalized it)
    updateSliderValue(changedSliderId, normalizedNewValue, true);
    
    // Update all displays with smart rounding to ensure 100% total
    updateAllSliderDisplays();
    saveAllWeights();
  }
  
  // Smart rounding function that ensures individual percentages add to exactly 100%
  function updateAllSliderDisplays() {
    const sliderIds = ['theme', 'volatility', 'studio', 'mechanics'];
    
    // Get actual float values
    const values = sliderIds.map(id => {
      const slider = document.getElementById(id);
      return slider ? parseFloat(slider.value) : 0;
    });
    
    // Convert to percentages and round
    const rawPercentages = values.map(v => v * 100);
    const roundedPercentages = rawPercentages.map(p => Math.round(p));
    
    // Calculate rounding discrepancy
    const targetTotal = 100;
    const currentTotal = roundedPercentages.reduce((sum, p) => sum + p, 0);
    const discrepancy = targetTotal - currentTotal;
    
    // Adjust the largest value to ensure perfect 100% total
    if (discrepancy !== 0) {
      // Find the index of the largest value
      let maxIndex = 0;
      for (let i = 1; i < roundedPercentages.length; i++) {
        if (roundedPercentages[i] > roundedPercentages[maxIndex]) {
          maxIndex = i;
        }
      }
      // Adjust the largest value by the discrepancy
      roundedPercentages[maxIndex] += discrepancy;
    }
    
    // Update displays
    sliderIds.forEach((id, index) => {
      const displayElement = document.getElementById(id + "-value");
      if (displayElement) {
        displayElement.textContent = roundedPercentages[index] + "%";
      }
    });
    
    // Update total display (should always be 100% now)
    updateTotalDisplay();
  }
  
  function updateTotalDisplay() {
    const totalElement = document.getElementById('total-percentage');
    if (totalElement) {
      // Always show 100% since we ensure it through smart rounding
      totalElement.textContent = '100%';
      
      // Always green since we guarantee 100%
      totalElement.parentElement.className = 'bg-green-100 border border-green-300 rounded-lg px-3 py-1';
    }
    
    console.log(`‚öñÔ∏è Slider total: 100%`);
  }
  
  function saveAllWeights() {
    const sliderIds = ['theme', 'volatility', 'studio', 'mechanics'];
    const weights = {};
    
    sliderIds.forEach(id => {
      const slider = document.getElementById(id);
      if (slider) {
        weights[id] = parseFloat(slider.value);
      }
    });
    
    localStorage.setItem("slotForge_weightPrefs", JSON.stringify(weights));
    console.log('üíæ Saved weights:', weights);
  }

  function validateGameCount(prompt) {
    if (!prompt) return { valid: true, count: 100 }; // Default to 100
    
    // Extract number from prompt
    const numbers = prompt.match(/\b(\d+)\b/g);
    if (!numbers) return { valid: true, count: 100 }; // Default if no number found
    
    // Get the largest number (assuming it's the game count)
    const gameCount = Math.max(...numbers.map(n => parseInt(n)));
    
    if (gameCount < 1) {
      return { valid: false, error: 'Must generate at least 1 game', count: gameCount };
    }
    
    if (gameCount > 100) {
      return { valid: false, error: 'Cannot generate more than 100 games', count: gameCount };
    }
    
    return { valid: true, count: gameCount };
  }
  
  function isGameGenerationPrompt(prompt) {
    if (!prompt) return true; // Empty prompt is fine
    
    const lowercased = prompt.toLowerCase();
    
    // Check for non-game generation patterns
    const nonGamePatterns = [
      /write.*(?:code|function|script|program)/,
      /create.*(?:website|app|application|database)/,
      /build.*(?:system|platform|tool)/,
      /explain.*(?:how to|concept|algorithm)/,
      /help.*(?:with|me)/,
      /what.*(?:is|are|does)/,
      /tell.*(?:me|about)/,
      /calculate|compute|solve/,
      /translate|convert/,
      /summarize|analyze/,
      /research|find.*information/,
      /send.*email|make.*call/,
      /access.*file|read.*document/,
      /install|download|update/
    ];
    
    // Check if request is clearly not about game generation
    const containsNonGameRequest = nonGamePatterns.some(pattern => pattern.test(lowercased));
    const containsGameKeywords = /(?:game|slot|casino|reel|spin|bet|win|bonus|jackpot|theme|volatility)/i.test(prompt);
    
    // Invalid if it contains non-game patterns and no game keywords
    return !(containsNonGameRequest && !containsGameKeywords);
  }

  function showPromptError(message) {
    // Remove existing error if any
    clearPromptError();
    
    // Create error message element
    const errorDiv = document.createElement('div');
    errorDiv.id = 'prompt-error';
    errorDiv.className = 'mt-2 p-3 bg-red-100 border border-red-400 text-red-700 rounded-md text-sm';
    errorDiv.innerHTML = `
      <div class="flex items-start">
        <svg class="w-4 h-4 mr-2 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
        </svg>
        <span>${message}</span>
      </div>
    `;
    
    // Insert after the textarea
    const textarea = document.getElementById('customPrompt');
    textarea.parentNode.insertBefore(errorDiv, textarea.nextSibling);
    
    // Add red border to textarea
    textarea.classList.add('border-red-400', 'focus:border-red-500', 'focus:ring-red-500');
    textarea.classList.remove('border-gray-300', 'focus:border-casino', 'focus:ring-casino');
  }

  function clearPromptError() {
    const existingError = document.getElementById('prompt-error');
    if (existingError) {
      existingError.remove();
    }
    
    // Reset textarea styling
    const textarea = document.getElementById('customPrompt');
    textarea.classList.remove('border-red-400', 'focus:border-red-500', 'focus:ring-red-500');
    textarea.classList.add('border-gray-300', 'focus:border-casino', 'focus:ring-casino');
  }

  // Progress source for Server-Sent Events (declared in broader scope)
  let progressSource = null;

  function handleGenerateSubmit(event) {
    console.log('üöÄ handleGenerateSubmit called - JavaScript working!');
    console.log('Event type:', event.type);
    console.log('Event target:', event.target);
    
    // Get UI elements in function scope (accessible to .then() and .catch() handlers)
    const progressArea = document.getElementById("generationProgress");
    const progressMessage = document.getElementById("progressMessage");  
    const progressBar = document.getElementById("progressBar");
    const button = document.getElementById("generateButton");
    const customPromptField = document.getElementById('customPrompt');
    
    try {
      event.preventDefault();
      console.log('‚úÖ preventDefault called');
      
      // Validate game count first
      const prompt = customPromptField ? customPromptField.value : '';
      const countValidation = validateGameCount(prompt);
      
      if (!countValidation.valid) {
        showPromptError(countValidation.error);
        return;
      }
      
      console.log(`üéØ Validated game count: ${countValidation.count}`);
      
      // Clear any existing errors
      clearPromptError();
      
      // Show progress immediately
      console.log('üîß Looking for progress elements...');
      
      console.log('Progress elements found:', {
        progressArea: !!progressArea,
        progressMessage: !!progressMessage,
        progressBar: !!progressBar
      });
      
      if (progressArea) {
        progressArea.classList.remove("hidden");
        console.log('‚úÖ Progress area shown');
      } else {
        console.error('‚ùå Progress area not found!');
      }
      
      if (progressMessage) {
        progressMessage.textContent = `Generating ${countValidation.count} games...`;
        console.log('‚úÖ Progress message updated');
      }
      
      if (progressBar) {
        progressBar.style.width = "10%";
        console.log('‚úÖ Progress bar width set to 10%');
      }
      
    } catch (error) {
      console.error('‚ùå Error in handleGenerateSubmit:', error);
    }

    // Set button state (button already declared in function scope)
    if (button) {
      button.disabled = true;
      button.textContent = "‚è≥ Generating...";
      button.classList.remove("bg-blue-600", "hover:bg-blue-700");
      button.classList.add("bg-gray-400", "cursor-not-allowed");
    }

    // Submit form via AJAX to get games JSON and store in localStorage  
    const form = document.getElementById("generateForm");
    const formData = new FormData(form);
    const urlEncoded = new URLSearchParams(formData);
    
    fetch('/generate', {
      method: 'POST',
      headers: {
        'X-Session-ID': sessionId,
        'X-Requested-With': 'XMLHttpRequest',
        'Accept': 'application/json',
        'Content-Type': 'application/x-www-form-urlencoded'
      },
      body: urlEncoded
    })
    .then(response => {
      console.log('üîç Fetch response received:', response.status, response.statusText);
      console.log('üîç Response headers:', response.headers);
      console.log('üîç Response content-type:', response.headers.get('content-type'));
      return response.json();
    })
    .then(data => {
      console.log('üîç JSON parsing successful, data:', data);
      // Close progress stream
      if (progressSource) {
        progressSource.close();
      }
      
      // Reset button state
      button.disabled = false;
      button.textContent = "üéØ Generate Games";
      button.classList.remove("bg-gray-400", "cursor-not-allowed");
      button.classList.add("bg-blue-600", "hover:bg-blue-700");
      
      // Hide progress area
      progressArea.classList.add("hidden");
      
      if (data.success) {
        // Save generated games to localStorage
        saveCustomGames(data.games);
        
        // Brief delay to show completion
        setTimeout(() => {
          window.location.href = `/?success=${encodeURIComponent(data.message)}&prompt=${encodeURIComponent(data.prompt)}`;
        }, 500);
      } else {
        // Handle error
        setTimeout(() => {
          window.location.href = `/?error=${encodeURIComponent(data.message || 'Generation failed')}`;
        }, 500);
      }
    })
    .catch(error => {
      // Reset button state on error
      button.disabled = false;
      button.textContent = "üéØ Generate Games";
      button.classList.remove("bg-gray-400", "cursor-not-allowed");
      button.classList.add("bg-blue-600", "hover:bg-blue-700");
      
      console.error('Generation failed:', error);
      
      // Provide more descriptive error messages based on error type
      let errorMessage = 'Generation failed. Please try again.';
      
      if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
        errorMessage = 'Connection failed - please check your internet connection and try again.';
      } else if (error.name === 'SyntaxError' && error.message.includes('JSON')) {
        errorMessage = 'Server response error - please refresh the page and try again.';
      } else if (error.message && error.message.includes('rate limit')) {
        errorMessage = 'Rate limit exceeded - please wait a moment and try again.';
      } else if (error.message && error.message.includes('timeout')) {
        errorMessage = 'Request timed out - please try again with fewer games or check your connection.';
      } else if (error.message && error.message.includes('API key')) {
        errorMessage = 'Configuration error - please contact support.';
      } else if (error.message) {
        errorMessage = `Generation failed: ${error.message}`;
      }
      
      window.location.href = `/?error=${encodeURIComponent(errorMessage)}`;
    });
  }

  function showProgressNotification(message, type = "info") {
    // Create notification element
    const notification = document.createElement("div");
    notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 transition-opacity duration-300 ${
      type === "success"
        ? "bg-green-500 text-white"
        : type === "error"
        ? "bg-red-500 text-white"
        : "bg-blue-500 text-white"
    }`;
    notification.innerHTML = `
      <div class="flex items-center">
        ${
          type === "info"
            ? `
          <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
        `
            : ""
        }
        <span>${message}</span>
      </div>
    `;

    document.body.appendChild(notification);

    // Auto-remove after 5 seconds (unless it's an error)
    if (type !== "error") {
      setTimeout(() => {
        notification.style.opacity = "0";
        setTimeout(() => notification.remove(), 300);
      }, 5000);
    }
  }
  
  // Handle recommendation form submission
  async function handleRecommendSubmit(event) {
    event.preventDefault();
    
    console.log('üöø Starting recommendation submission...');
    console.log('Session ID:', sessionId);
    
    // Show loading state
    const submitButton = event.target.querySelector('button[type="submit"]');
    const originalText = submitButton.textContent;
    submitButton.disabled = true;
    submitButton.textContent = 'üîÑ Syncing games...';
    
    // Get the selected game ID to debug
    const gameSelect = document.getElementById('gameId');
    const selectedGameId = gameSelect ? gameSelect.value : 'none';
    console.log('Selected game ID:', selectedGameId);
    
    try {
      // Sync custom games before submitting
      console.log('üîÑ Syncing custom games to server...');
      const syncResult = await syncCustomGamesToServer();
      console.log('Sync result:', syncResult);
      
      // Small delay to ensure sync completes
      await new Promise(resolve => setTimeout(resolve, 800));
      
      // Reset button
      submitButton.disabled = false;
      submitButton.textContent = originalText;
      
      console.log('‚úÖ Submitting form now...');
      // Now submit the form
      event.target.submit();
    } catch (error) {
      console.error('‚ùå Failed to sync games:', error);
      
      // Reset button
      submitButton.disabled = false;
      submitButton.textContent = originalText;
      
      console.log('‚ö†Ô∏è Submitting anyway with default behavior...');
      // Submit anyway - might work with default games
      event.target.submit();
    }
    
    return false; // Prevent default form submission
  }


  // Update game dropdown with unified game list (custom games replace defaults completely)
  function updateGameDropdown() {
    const gameSelect = document.getElementById('gameId');
    if (!gameSelect) return;
    
    const customGames = loadCustomGames();
    
    // Clear existing options except the first one ("Select a game...")
    while (gameSelect.children.length > 1) {
      gameSelect.removeChild(gameSelect.lastChild);
    }
    
    if (customGames && customGames.length > 0) {
      // Use ONLY custom games - no separation, no default games
      customGames.forEach(game => {
        const option = document.createElement('option');
        option.value = game.id;
        option.textContent = `${game.title} - ${game.studio} (${game.volatility} volatility, ${game.rtp}% RTP)`;
        gameSelect.appendChild(option);
      });
      
      // Update dataset count display to show custom games count
      const countDisplay = document.querySelector('span.font-bold.text-casino');
      if (countDisplay) {
        countDisplay.textContent = customGames.length;
      }
    } else {
      // No custom games - show default games
      const defaultGames = <%- JSON.stringify(games) %>;
      defaultGames.forEach((game) => {
        const option = document.createElement('option');
        option.value = game.id;
        option.textContent = `${game.title} - ${game.studio} (${game.volatility} volatility, ${game.rtp}% RTP)`;
        gameSelect.appendChild(option);
      });
    }
  }

  // Save custom prompt to sessionStorage
  function saveCustomPrompt(prompt) {
    sessionStorage.setItem('slotForge_customPrompt', prompt);
  }
  
  // Load custom prompt from sessionStorage
  function loadCustomPrompt() {
    return sessionStorage.getItem('slotForge_customPrompt') || '';
  }

  // Load saved preferences on page load
  document.addEventListener("DOMContentLoaded", function () {
    console.log("üîß DOM loaded, starting initialization...");
    
    // Load custom games and update dropdown (custom games take priority)
    updateGameDropdown();
    
    // Sync any existing custom games to server on page load
    syncCustomGamesToServer();
    
    // Load saved custom prompt
    const customPromptField = document.getElementById('customPrompt');
    if (customPromptField) {
      const savedPrompt = loadCustomPrompt();
      if (savedPrompt) {
        customPromptField.value = savedPrompt;
      }
      
      // Save prompt on every change
      customPromptField.addEventListener('input', function() {
        saveCustomPrompt(this.value);
        
        // Clear error when user starts typing
        const existingError = document.getElementById('prompt-error');
        if (existingError) {
          clearPromptError();
        }
      });
    }
    
    // CRITICAL: Attach button click handler via JavaScript
    console.log("üîß Looking for generateButton...");
    const generateButton = document.getElementById('generateButton');
    if (generateButton) {
      console.log("‚úÖ Found generateButton, attaching click handler");
      console.log("Button element:", generateButton);
      console.log("Button disabled?", generateButton.disabled);
      console.log("Button style display:", getComputedStyle(generateButton).display);
      
      // Test basic click detection first
      generateButton.addEventListener('click', function(event) {
        alert('BUTTON CLICKED - JavaScript working!');
        console.log('üî• BUTTON CLICKED! Handler triggered');
        console.log('Event details:', event);
        handleGenerateSubmit(event);
      });
      console.log("‚úÖ Click handler attached successfully");
      
      // Also try mousedown as backup
      generateButton.addEventListener('mousedown', function() {
        console.log('üñ±Ô∏è MOUSEDOWN detected on button');
      });
      
      // Also try mouseup
      generateButton.addEventListener('mouseup', function() {
        console.log('üñ±Ô∏è MOUSEUP detected on button');
        console.log('Manually triggering handleGenerateSubmit...');
        handleGenerateSubmit({ type: 'mouseup', target: generateButton, preventDefault: () => {} });
      });
      
    } else {
      console.error('‚ùå Generate button not found!');
      console.log('Available buttons:', document.querySelectorAll('button'));
    }
    
    // Load saved slider preferences and ensure they add up to 100%
    const savedPrefs = JSON.parse(
      localStorage.getItem("slotForge_weightPrefs") || "{}"
    );
    
    // Default values that sum to 100%
    const defaultWeights = {
      theme: 0.4,
      volatility: 0.3, 
      studio: 0.2,
      mechanics: 0.1
    };
    
    // Use saved preferences or defaults
    const weights = Object.keys(defaultWeights).reduce((acc, key) => {
      acc[key] = savedPrefs[key] !== undefined ? savedPrefs[key] : defaultWeights[key];
      return acc;
    }, {});
    
    // Normalize to ensure 100% total
    const currentTotal = Object.values(weights).reduce((sum, val) => sum + val, 0);
    if (currentTotal !== 1.0) {
      console.log(`‚ö†Ô∏è Normalizing weights from ${Math.round(currentTotal * 100)}% to 100%`);
      Object.keys(weights).forEach(key => {
        weights[key] = weights[key] / currentTotal;
      });
    }
    
    // Apply normalized weights to sliders
    Object.keys(weights).forEach((sliderId) => {
      const slider = document.getElementById(sliderId);
      if (slider) {
        slider.value = weights[sliderId];
        updateSliderValue(sliderId, weights[sliderId], true); // Skip rebalance during initialization
      }
    });

    // Detect and send client context
    detectAndSendClientContext();
    
    console.log("üîß Initialization complete. Checking all elements...");
    console.log("Elements check:", {
      generateButton: !!document.getElementById('generateButton'),
      generateForm: !!document.getElementById('generateForm'),
      progressArea: !!document.getElementById('generationProgress'),
      progressMessage: !!document.getElementById('progressMessage'),
      progressBar: !!document.getElementById('progressBar'),
      customPrompt: !!document.getElementById('customPrompt')
    });
  });
</script>

<%- include('partials/footer') %>
